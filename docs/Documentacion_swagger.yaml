openapi: 3.0.0
info:
  title: API de Reseñas y Votos
  description: API para gestionar calificaciones de productos, reseñas y votos sobre comentarios.
  version: 1.1.0
servers:
  - url: /
    description: Servidor relativo (por defecto http://localhost:3001)
tags:
  - name: Salud
    description: Endpoints de salud de la API.
  - name: Reseñas
    description: Operaciones sobre calificaciones y comentarios de productos.
  - name: Votos
    description: Operaciones para votar comentarios (útil/no útil).

paths:
  /health:
    get:
      tags: [Salud]
      summary: Comprobar estado de la API
      responses:
        '200':
          description: API operativa
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true

  /:
    get:
      tags: [Salud]
      summary: Mensaje de bienvenida
      responses:
        '200':
          description: Mensaje por defecto
          content:
            text/plain:
              schema:
                type: string
                example: Hello World!

  /ratings/{productId}/average:
    get:
      tags: [Reseñas]
      summary: Obtener promedio y cantidad de reseñas de un producto
      parameters:
        - name: productId
          in: path
          required: true
          description: ID numérico del producto.
          schema:
            type: integer
      responses:
        '200':
          description: Promedio y cantidad de reseñas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AverageResponse'

  /ratings/{productId}/comments:
    get:
      tags: [Reseñas]
      summary: Listar reseñas de un producto con votos y paginación
      parameters:
        - name: productId
          in: path
          required: true
          description: ID numérico del producto.
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          description: Cantidad máxima de reseñas a devolver (tope 50, por defecto 10).
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
        - name: offset
          in: query
          required: false
          description: Desplazamiento para la paginación (por defecto 0).
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Lista paginada de reseñas del producto con conteo de votos.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedResenas'

    post:
      tags: [Reseñas]
      summary: Crear reseña bajo la ruta /comments (alias de puntuar producto)
      description: >
        Crea o actualiza una reseña para un producto. Es un alias semántico de
        **POST /ratings/{productId}**.
      parameters:
        - name: productId
          in: path
          required: true
          description: ID numérico del producto.
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateResenaDto'
      responses:
        '200':
          description: Reseña creada o actualizada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpsertReviewResponse'
        '400':
          description: Error de validación o de datos
        '409':
          description: Conflicto por restricciones de base de datos

  /ratings/publicacion/{productId}:
    get:
      tags: [Reseñas]
      summary: Listar solo las reseñas para microservicio de Publicaciones
      description: >
        Devuelve únicamente el arreglo de reseñas (`items`) para que el backend
        principal pueda inyectarlo directamente en la respuesta de la publicación.
      parameters:
        - name: productId
          in: path
          required: true
          description: ID numérico del producto.
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          description: Cantidad máxima de reseñas a devolver (tope 50, por defecto 10).
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
        - name: offset
          in: query
          required: false
          description: Desplazamiento para la paginación (por defecto 0).
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Arreglo de reseñas del producto
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ResenaWithVotes'

  /ratings/{productId}:
    post:
      tags: [Reseñas]
      summary: Puntuar un producto (comentario opcional)
      description: >
        Crea o actualiza una reseña para un producto específico. Si el comprador
        ya tenía una reseña para ese producto, se actualiza; de lo contrario, se crea.
      parameters:
        - name: productId
          in: path
          required: true
          description: ID numérico del producto.
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RateOnlyDto'
      responses:
        '200':
          description: Reseña creada o actualizada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpsertReviewResponse'
        '400':
          description: Error de validación o de datos
        '409':
          description: Conflicto por restricciones de base de datos

  /ratings/comments/{idResena}:
    delete:
      tags: [Reseñas]
      summary: Eliminar reseña (solo puede hacerlo el autor)
      parameters:
        - name: idResena
          in: path
          required: true
          description: ID UUID de la reseña a eliminar.
          schema:
            type: string
      responses:
        '200':
          description: Reseña eliminada correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResenaResponse'
        '400':
          description: Error de validación
        '403':
          description: Intento de eliminar una reseña de otro usuario
        '404':
          description: Reseña no encontrada

  /ratings/comments/{idResena}/vote:
    post:
      tags: [Votos]
      summary: Votar una reseña como útil o no útil
      parameters:
        - name: idResena
          in: path
          required: true
          description: ID UUID de la reseña a votar.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteDto'
      responses:
        '200':
          description: Voto registrado correctamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VoteResponse'
        '400':
          description: Error de validación

components:
  schemas:
    RateOnlyDto:
      type: object
      required:
        - productId
        - idComprador
        - idVendedor
        - puntuacion
        - nombreComprador
      properties:
        productId:
          type: string
          description: ID del producto (en formato string numérico).
          example: "123"
        idComprador:
          type: integer
          example: 42
        idVendedor:
          type: integer
          example: 99
        puntuacion:
          type: integer
          minimum: 1
          maximum: 5
          example: 5
        comentario:
          type: string
          maxLength: 500
          nullable: true
          description: Comentario opcional de la reseña.
        nombreComprador:
          type: string
          maxLength: 100
          example: "Juan Pérez"

    CreateResenaDto:
      type: object
      required:
        - idComprador
        - idVendedor
        - puntuacion
        - nombreComprador
      properties:
        idComprador:
          type: integer
          example: 42
        idVendedor:
          type: integer
          example: 99
        puntuacion:
          type: integer
          minimum: 1
          maximum: 5
          example: 4
        comentario:
          type: string
          maxLength: 500
          nullable: true
          description: Comentario opcional de la reseña.
        nombreComprador:
          type: string
          maxLength: 100
          example: "Juanita Compradora"

    VoteDto:
      type: object
      required:
        - idUsuario
        - voto
      properties:
        idUsuario:
          type: integer
          example: 1001
        voto:
          type: string
          enum: [up, down]
          example: up

    Resena:
      type: object
      properties:
        idResena:
          type: string
          format: uuid
        idProducto:
          type: integer
        idComprador:
          type: integer
        idVendedor:
          type: integer
        comentario:
          type: string
          nullable: true
        puntuacion:
          type: integer
          minimum: 1
          maximum: 5
        fechaResena:
          type: string
          format: date-time
        nombreComprador:
          type: string

    ResenaWithVotes:
      type: object
      properties:
        idResena:
          type: string
          format: uuid
        comentario:
          type: string
          nullable: true
        puntuacion:
          type: integer
          minimum: 1
          maximum: 5
        fecha:
          type: string
          format: date-time
        idComprador:
          type: integer
        nombreComprador:
          type: string
        votos:
          type: object
          properties:
            up:
              type: integer
            down:
              type: integer

    PaginatedResenas:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ResenaWithVotes'
        total:
          type: integer
          description: Total de reseñas encontradas para el producto.
        limit:
          type: integer
        offset:
          type: integer

    AverageResponse:
      type: object
      properties:
        productId:
          type: integer
        average:
          type: number
          format: float
          description: Promedio de puntuación del producto (1..5).
        count:
          type: integer
          description: Cantidad de reseñas consideradas en el promedio.

    UpsertReviewResponse:
      type: object
      properties:
        idResena:
          type: string
          format: uuid
        action:
          type: string
          enum: [created, updated]
          description: Indica si la reseña fue creada o actualizada.

    DeleteResenaResponse:
      type: object
      properties:
        status:
          type: string
          enum: [deleted]
          example: deleted

    VoteResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
          example: ok
